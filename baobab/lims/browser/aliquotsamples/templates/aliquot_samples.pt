<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
            metal:use-macro="here/main_template/macros/master"
      i18n:domain="bika">

<head>
    <metal:block fill-slot="javascript_head_slot"
            tal:define="portal context/@@plone_portal_state/portal;">
        <script type="text/javascript"
                tal:attributes="src python:portal.absolute_url() + '/bika_widgets/datetimewidget.js'"></script>
        <script type="text/javascript"
                tal:attributes="src python:portal.absolute_url() + '/bika_widgets/referencewidget.js'"></script>


        <script type="text/javascript" charset="utf-8">

            (function($){
                $(function(){
                    var dataPost = {};

                    // $("#assemble").on("click", function (e) {
                    //     var path = window.location.href.split('/?')[0];
                    //      $.ajax({
                    //          dataType: "json",
                    //          contentType: 'application/json',
                    //          url: path + '/fetch_stock_prds',
                    //          data: JSON.stringify(dataPost),
                    //          success: function (data) {
                    //              if (data["error"]){
                    //                  window.bika.lims.portalWarningMessage(data.error);
                    //              }
                    //              else{
                    //                  window.bika.lims.portalInfoMessage("Stock Items Selected");
                    //              }
                    //          }
                    //      });
                    //     e.preventDefault();
                    // });

                    $(".one_more_aliquot").on("click", function(e){
                        console.log("test this log");
                        console.debug("test this debug");
                        alert('This is a click test');
                        e.preventDefault();
                    });



                    $("#new_sample_group").on("click", function(e){
                        // alert('This is a new click test.');
                        sample_groups = $('.sample_group')
                        next_sample_group = sample_groups.length + 1;

                        var sample_group_div = '\
                            <div class="sample_group">\
                                <div>\
                                    <select id="sample_group_' + next_sample_group + '">\
                                        <option value="0">-- Select a sample to Aliquot --</option>\
                                    </select>\
                                    <button class="one_more_aliquot" id="btn_sample_group_' + next_sample_group + '">One more aliquot</button>\
                                </div>\
                                <div class="sample' + next_sample_group + '_aliquots">\
                                    <table id="aliquots_table_' + next_sample_group + '">\
                                        <tr>\
                                            <th>Barcode</th>\
                                            <th>Volume</th>\
                                        </tr>\
                                        <tr class="aliquots_' + next_sample_group + '_rows aliquot_rows aliquots_' + next_sample_group + '_row_1">\
                                            <td><input type="text" id="aliquots_' + next_sample_group + '_barcode_row_1" class="barcode"></td>\
                                            <td><input type="text" id="aliquots_' + next_sample_group + '_volume_row_1" class="volume"></td>\
                                        </tr>\
                                    </table>\
                                </div>\
                            </div>';

                        $('#samples_and_aliquots_groups').append(sample_group_div);
                        $("#btn_sample_group_" + next_sample_group).on('click', add_aliquot_row);

                        get_samples('sample_group_' + next_sample_group);


                        e.preventDefault();
                    });

                    $("#create_aliquots").on("click", function(e){
                        aliquots_data = get_aliquots_data();

                        final_data = JSON.stringify(aliquots_data);

                        console.log('----final aliquots data');
                        console.log(final_data);


                        //
                        var path = window.location.href.split('/aliquotsamples')[0];

                        $.ajax({
                            dataType: "json",
                            contentType: 'application/json',
                            url: path + '/ajax_create_aliquots',
                            data: {'sample_aliquots': final_data},
                            success: function (data) {

                                console.log('------successfully posted the aliquots data')

                                // if (data["error"]){
                                //     window.bika.lims.portalWarningMessage(data.error);
                                // }
                                // else{
                                //     window.bika.lims.portalInfoMessage("Stock Items Selected");
                                // }
                            }
                        });

                      e.preventDefault();
                    });

                });
            })(jQuery);

        </script>

        <script type="text/javascript" charset="utf-8">
            function get_aliquots_data(){
                console.log('-----------get_aliquots_data reched');
                aliquots_data = {};

                // iterate all the sample groups and extract their values to be posted
                $('.sample_group').each(function(grp_index, sample_group){
                    //extract the uid of the sample that was selected
                    select_value = $(sample_group).find('select').val();

                    //extract the aliquots that are being created in this sample group
                    var aliquots = [];
                    $(sample_group).find('.aliquot_rows').each(function(alqt_index, aliquot_row){
                        barcode = $(aliquot_row).find('.barcode').val();
                        volume = $(aliquot_row).find('.volume').val();

                        aliquots.push(
                            {
                              'barcode': barcode,
                              'volume': volume
                            }
                        );
                    });

                    aliquots_data[select_value] = aliquots;
                });
                return aliquots_data;
            }
        </script>

        <script type="text/javascript" charset="utf-8">
            function get_samples(select_id){
                var path = window.location.href.split('/aliquotsamples')[0];

                 $.ajax({
                     dataType: "json",
                     contentType: 'application/json',
                     url: path + '/ajax_get_samples',
                     success: function (data) {
                         $.each(data, function() {
                            $.each(this, function(key, value){
                                $('#' + select_id).append($('<option>').val(key).text(value));
                            });
                        });
                     }
                 });
            }
        </script>

        <script type="text/javascript" charset="utf-8">
            function add_aliquot_row(event){
                event.preventDefault();
                // get the sample group number from the id on the button
                id = this.id;
                sample_group = id.substring(17);

                // get the table
                table_id = "aliquots_table_" + sample_group;

                // get the rows in this table
                aliquot_rows = $('.aliquots_' + sample_group + '_rows');
                row_count = aliquot_rows.length + 1;

                // create a new row
                var new_row = '\
                    <tr class="aliquots_' + sample_group + '_rows aliquot_rows">\
                        <td><input type="text" id="aliquots_' + sample_group + '_barcode_row_' + row_count + '" class="barcode"></td>\
                        <td><input type="text" id="aliquots_' + sample_group + '_volume_row_' + row_count + '" class="volume"></td> \
                    </tr>\
                    ';

                // add it to the table
                $('#' + table_id + ' tr:last' ).after(new_row);
           }

        </script>

        <link rel="stylesheet" type="text/css" media="all" href=""
                tal:attributes="href string:${portal/absolute_url}/bika_widgets/referencewidget.css"/>
    </metal:block>


    <metal:css fill-slot="style_slot">
        <tal:css>
            <style type="text/css"
                   media="all">
                .main_buttons{
                    height: 100px;
                    width: 200px;
                    background-color: #e7e7e7;
                }
                #new_aliquot{
                    float: left;
                }
                #create_aliquots{
                    float: right;
                }
                .one_more_aliquot{
                    height: 30px;
                    width: 150px;
                    background-color: #e7e7e7;
                    /*float: right;*/
                }
            </style>
        </tal:css>
    </metal:css>

</head>

<body>
<metal:title fill-slot="content-title">
    <h2>
        <img tal:attributes="src string:${view/portal_url}/++resource++baobab.lims.images/biospecimen_big.png"/>
        Create sample Aliquots
    </h2>
</metal:title>
    <div metal:fill-slot="content-core"
     tal:define="
        portal context/@@plone_portal_state/portal;
        plone_view context/@@plone;
        portal_state context/@@plone_portal_state;">


        <div id="aliquots_from_sample">
            <form name="add-aliquots" action="ajax_create_aliquots" method="POST">
                <div id="samples_and_aliquots_groups">


                </div>
                <div id="buttons-group">
                    <button class="main_buttons" id="new_sample_group">New Sample Group</button>
                    <button class="main_buttons" id="create_aliquots">Save Aliquot Groups</button>
                </div>
            </form>
        </div>

    </div>
</body>
</html>