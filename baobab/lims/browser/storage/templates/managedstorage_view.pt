<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      xmlns="http://www.w3.org/1999/xhtml"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="baobab">

<head>
<metal:block fill-slot="javascript_head_slot">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script type="text/javascript" src="++theme++graphite.theme/js/vakata-jstree-6dce227/dist/jstree.js"></script>
        <script type="text/javascript">
         var jQuery_1_4_2 = jQuery.noConflict();
         (function($) {
             $(document).ready(function(){
                var _p = window.jarn.i18n.MessageFactory("plone");
                // $.ajax({
                //     dataType: "json",
                //     contentType: 'application/json',
                //     url: window.location.href +'/jstree',
                //     success: function (data) {
                //         return data

                //     },
                //     error: function(data){
                //         debugger;
                //         // $(sample_details).html();
                //         // console.log('------An error here');
                //         // console.log(data);

                //     },
                // });
                $("#sidebar-jstree").jstree({
                    'core': {
                        //'data': data.data,
                        'multiple' : true,
                        'data': {"url": window.location.href +'/jstree',
                                 "data": function(node){
                                    return {'id': node.id}
                                }
                        },
                    },
                    "types": {
                      "default": {
                        "icon": false
                      },
                    },
                    "plugins": ["types", "ui", "actions", "checkbox"], //contextmenu
                    // "contextmenu":{
                    //     "items": function($node) {
                    //         var tree = $('#sidebar-jstree').jstree(true);
                    //         /*
                    //         $.each( obj, function( key, value ) {
                    //             debugger;
                    //           alert( key + ": " + value );
                    //         });
                    //         var workflow_actions = obj.actions */
                    //         console.log(tree.get_selected())
                    //         // call the workflow
                    //         return {
                    //             "reserve": {
                    //                 "separator_before": false,
                    //                 "separator_after": false,
                    //                 "label": "Reserve",
                    //                 "action": function (obj) {
                    //                     // tree.edit($node);
                    //                      window.location.href = $node['id']+"/content_status_modify?workflow_action=reserve";
                    //                 }
                    //             },
                    //             "liberate": {
                    //                 "separator_before": false,
                    //                 "separator_after": false,
                    //                 "label": "Liberate",
                    //                 "action": function (obj) {
                    //                     tree.edit($node);
                    //                     window.location.href = $node['id']+"/content_status_modify?workflow_action=liberate";
                    //                 }
                    //             },
                    //         };
                    //     }
                    // }// end of return

                   })

                $('#sidebar-jstree').on("changed.jstree", function (e, data) {
                      var to = e.pageY || window.event.pageY
                      var i, j, r = [];
                      for(i = 0, j = data.selected.length; i < j; i++) {
                        r.push(data.instance.get_node(data.selected[i]).text);
                      }
                      console.log(data.selected.length)
                      console.log(data.instance.get_node(data.selected[0]).text);
                      console.log($(this).closest('li').text())
                      console.log(to)
                      if (data.selected.length> 0) {
                          var firstchk = $('.jstree-clicked')
                          var leftpos = $(firstchk).offset().left;
                          $('.workflow_actions').css({
                               top: to - 10,
                               left: leftpos + 20
                          });
                          updateSelectedItems($(this).closest('jstree-anchor jstree-clicked'));
                          // firstchk = firstchk.first();
                          $('.workflow_actions').show();
                      } else {
                          $('.workflow_actions').hide();
                      }


                      function updateSelectedItems(table) {
                          var numsels = data.selected.length
                          if (numsels > 0) {
                              if ($('.workflow_actions div.selection-summary').length == 0) {
                                  $('.workflow_actions').prepend('<div class="selection-summary"><span class="num-selected">'+numsels+'</span> '+_p('Items selected')+'</div>');
                              } else {
                                  $('.workflow_actions div.selection-summary span.num-selected').html(numsels);
                              }
                              $('.workflow_actions').show();
                          } else {
                              $('.workflow_actions').hide();
                          }
                      }






                    })
                //--
             });
        })(jQuery_1_4_2);
        </script>
</metal:block>
<metal:css fill-slot="style_slot">
        <link rel="stylesheet" type="text/css" media="all" href="++theme++graphite.theme/js/vakata-jstree-6dce227/dist/themes/default/style.min.css" />
        <style>
            .workflow_actions{
                position: absolute;
                display: none;
                color: #0B486B;
                background-color: #FFFFFF;
                border: 1px solid #AFAFAF;
                border-radius: 5px 5px 5px 5px;
                box-shadow: 1px 2px 10px #dcdcdc;
                padding: 5px;
                margin: 5px;
            }
            .selection-summary{
                color: #0B486B;
                font-size: 1.1em;
                font-weight: bold;
                line-height: 160%;
                padding-left: 12px;
            }
        </style>
</metal:css>
</head>

<body>


<metal:core fill-slot="content-core">
    <div style="float:left; width:30%; margin:0">
        <div style="text-align: left; overflow:auto; height:500px">
            <form id="list" action="workflow_action" method="post" name="bika_listing_form">
                <div id="sidebar-jstree">
                </div>
                <div class="workflow_actions">
                  <span class="workflow_action_buttons"
                        tal:define="actions view/get_workflow_actions">
                    <span tal:omit-tag="python:True" tal:repeat="action actions"
                          tal:condition="view/show_workflow_action_buttons">

                      <input
                          type="hidden"
                          tal:attributes="name action/id;
                                          value action/id;"/>
                      <input
                          class="context workflow_action_button action_button allowMultiSubmit"
                          type="submit"
                          name="workflow_action_button"
                          i18n:attributes="value"
                          i18n:domain="bika"
                          tal:attributes="id python:action['id']+'_transition';
                                          transition action/id;
                                          value action/title;
                                          url python:action.get('url', '');"/>
                    </span>
                  </span>
                </div>
            </form>
         </div>
    </div>
    <div style="float:left; width:70%;">
        <div style="text-align: center;  margin-left:5px">
            <span tal:replace="structure view/graph"/>
        </div>
    </div>
</metal:core>

</body>

</html>
